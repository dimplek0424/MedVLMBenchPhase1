"""
Compare MedCLIP zero-shot disease performance across 3 image variants
on the IU-CXR pathology-rich sanity subset:

    - Normalized images
    - CLAHE images
    - Gauss+CLAHE images

Inputs (already generated by your other scripts):

    Metrics CSVs (per disease, per variant):
        medclip_disease_sanity_<tag>_zero_shot_metrics.csv
        where <tag> in {normalized, clahe, gaussclahe}

    Prediction CSVs (per image, per variant):
        medclip_disease_sanity_<tag>_preds.csv

This script produces a single combined PDF:

    medclip_disease_sanity_COMPARISON_REPORT.pdf

Pages:
    1. Overall macro AUROC & macro F1@0.5 (this is your "all diseases" view)
    2. Disease-wise AUROC comparison
    3. Disease-wise F1@0.5 comparison
    4. Inference time distribution (boxplot)
    5. Text summary of macro metrics and timing
"""

import os
import pandas as pd
import matplotlib.pyplot as plt
from matplotlib.backends.backend_pdf import PdfPages

# -------------------------------------------------------------------
# PATHS – update ONLY if your folder structure changes
# -------------------------------------------------------------------

RESULTS_DIR = r"D:\MedVLMBench\phase1\results"

# Per-disease metrics files created by eval_medclip_disease_sanity_metrics.py
METRIC_FILES = {
    "normalized": "medclip_disease_sanity_normalized_zero_shot_metrics.csv",
    "clahe": "medclip_disease_sanity_clahe_zero_shot_metrics.csv",
    "gaussclahe": "medclip_disease_sanity_gaussclahe_zero_shot_metrics.csv",
}

# Per-image prediction files created by eval_medclip_disease_sanity.py
PREDS_FILES = {
    "normalized": "medclip_disease_sanity_normalized_preds.csv",
    "clahe": "medclip_disease_sanity_clahe_preds.csv",
    "gaussclahe": "medclip_disease_sanity_gaussclahe_preds.csv",
}

OUTPUT_PDF = os.path.join(
    RESULTS_DIR, "medclip_disease_sanity_COMPARISON_REPORT.pdf"
)


# -------------------------------------------------------------------
# Loading helpers
# -------------------------------------------------------------------

def load_metrics():
    """
    Read the per-disease metrics tables into a dict:
        tag -> DataFrame

    Expected columns in each metrics CSV:
        'Disease', 'AUROC', 'F1@0.5', ...
    """
    dfs = {}
    for tag, filename in METRIC_FILES.items():
        path = os.path.join(RESULTS_DIR, filename)
        if not os.path.exists(path):
            raise FileNotFoundError(f"Metrics file not found for '{tag}': {path}")
        df = pd.read_csv(path)
        dfs[tag] = df
    return dfs


def load_inference_times():
    """
    Read the per-image inference time column from each preds CSV.

    Expected column:
        'Inference_Time_ms'
    """
    times = {}
    for tag, filename in PREDS_FILES.items():
        path = os.path.join(RESULTS_DIR, filename)
        if not os.path.exists(path):
            raise FileNotFoundError(f"Preds file not found for '{tag}': {path}")
        df = pd.read_csv(path)
        if "Inference_Time_ms" not in df.columns:
            raise KeyError(f"'Inference_Time_ms' not found in {path}")
        times[tag] = df["Inference_Time_ms"].dropna()
    return times


# -------------------------------------------------------------------
# Plot helpers
# -------------------------------------------------------------------

def plot_macro_overall(ax, metric_dfs, column, ylabel, title):
    """
    Plot a single bar per image variant using the macro average of `column`
    across the 5 CheXpert competition diseases.

    This gives your "general all diseases" view:
        macro AUROC or macro F1@0.5
    """
    tags = ["normalized", "clahe", "gaussclahe"]
    labels = ["Normalized", "CLAHE", "Gauss+CLAHE"]
    colors = ["#1f77b4", "#ff7f0e", "#2ca02c"]

    macro_vals = []
    for tag in tags:
        df = metric_dfs[tag]
        if column not in df.columns:
            raise KeyError(f"Column '{column}' not found in metrics for '{tag}'")
        macro_vals.append(df[column].mean())

    x = range(len(tags))
    bars = ax.bar(x, macro_vals, color=colors)
    ax.set_xticks(list(x))
    ax.set_xticklabels(labels)
    ax.set_ylabel(ylabel)
    ax.set_title(title)

    # show the numeric values above each bar
    for i, (bar, v) in enumerate(zip(bars, macro_vals)):
        ax.text(
            bar.get_x() + bar.get_width() / 2.0,
            v + 0.01,
            f"{v:.3f}",
            ha="center",
            va="bottom",
            fontsize=9,
        )


def plot_bar_diseasewise(ax, metric_dfs, column, ylabel, title):
    """
    Grouped bar chart for disease-wise metrics.

    X-axis: diseases
    Bars: normalized vs CLAHE vs Gauss+CLAHE

    `column` should be "AUROC" or "F1@0.5".
    """
    # Use disease order from normalized run
    diseases = metric_dfs["normalized"]["Disease"].tolist()
    x = range(len(diseases))

    width = 0.25
    offsets = [-width, 0, width]

    tags = ["normalized", "clahe", "gaussclahe"]
    labels = ["Normalized", "CLAHE", "Gauss+CLAHE"]
    colors = ["#1f77b4", "#ff7f0e", "#2ca02c"]

    for i, (tag, label, color) in enumerate(zip(tags, labels, colors)):
        df = metric_dfs[tag]
        if column not in df.columns:
            raise KeyError(f"Column '{column}' not found in metrics for '{tag}'")
        values = df[column].values
        ax.bar(
            [p + offsets[i] for p in x],
            values,
            width,
            label=label,
            color=color,
        )

    ax.set_xticks(list(x))
    ax.set_xticklabels(diseases, rotation=30, ha="right")
    ax.set_ylabel(ylabel)
    ax.set_title(title)
    ax.legend()


def plot_inference_time_boxplot(ax, time_dict):
    """
    Boxplot showing inference time (ms) distribution for each variant.
    """
    data = [
        time_dict["normalized"],
        time_dict["clahe"],
        time_dict["gaussclahe"],
    ]
    labels = ["Normalized", "CLAHE", "Gauss+CLAHE"]

    bp = ax.boxplot(
        data,
        labels=labels,
        patch_artist=True,
        showmeans=True,
    )

    # Slight transparency so it looks less heavy but still simple
    for box in bp["boxes"]:
        box.set_alpha(0.6)

    ax.set_ylabel("Inference Time per Image (ms)")
    ax.set_title("Inference Time Distribution (CPU)")


# -------------------------------------------------------------------
# Main
# -------------------------------------------------------------------

def main():
    # Load per-disease metrics and per-image inference times
    metric_dfs = load_metrics()
    times = load_inference_times()

    os.makedirs(RESULTS_DIR, exist_ok=True)

    with PdfPages(OUTPUT_PDF) as pdf:

        # --------------- Page 1: "General all diseases" (macro) ---------------
        fig, axes = plt.subplots(1, 2, figsize=(11, 4))

        # Macro AUROC across diseases
        plot_macro_overall(
            axes[0],
            metric_dfs,
            column="AUROC",
            ylabel="Macro AUROC",
            title="Overall Macro AUROC\n(5 CheXpert competition diseases)",
        )

        # Macro F1@0.5 across diseases
        plot_macro_overall(
            axes[1],
            metric_dfs,
            column="F1@0.5",
            ylabel="Macro F1-score @ 0.5",
            title="Overall Macro F1-score\n(5 CheXpert competition diseases)",
        )

        fig.suptitle(
            "MedCLIP Zero-Shot Disease Classification – IU-CXR Pathology-Rich Sanity Subset",
            fontsize=12,
        )
        fig.tight_layout(rect=[0.02, 0.05, 0.98, 0.88])
        pdf.savefig(fig)
        plt.close(fig)

        # --------------- Page 2: Disease-wise AUROC ---------------
        fig, ax = plt.subplots(figsize=(10, 5))
        plot_bar_diseasewise(
            ax,
            metric_dfs,
            column="AUROC",
            ylabel="AUROC",
            title="Disease-wise AUROC Comparison\n(MedCLIP zero-shot)",
        )
        fig.tight_layout()
        pdf.savefig(fig)
        plt.close(fig)

        # --------------- Page 3: Disease-wise F1@0.5 ---------------
        fig, ax = plt.subplots(figsize=(10, 5))
        plot_bar_diseasewise(
            ax,
            metric_dfs,
            column="F1@0.5",
            ylabel="F1-score @ 0.5",
            title="Disease-wise F1-score Comparison\n(MedCLIP zero-shot, threshold=0.5)",
        )
        fig.tight_layout()
        pdf.savefig(fig)
        plt.close(fig)

        # --------------- Page 4: Inference time distribution ---------------
        fig, ax = plt.subplots(figsize=(8, 5))
        plot_inference_time_boxplot(ax, times)
        fig.tight_layout()
        pdf.savefig(fig)
        plt.close(fig)

        # --------------- Page 5: Text summary of macro metrics ---------------
        fig, ax = plt.subplots(figsize=(10, 6))
        ax.axis("off")

        lines = ["Macro performance summary across 5 CheXpert diseases:\n"]
        tags = ["normalized", "clahe", "gaussclahe"]

        for tag in tags:
            df = metric_dfs[tag]
            macro_auroc = df["AUROC"].mean()
            macro_f1 = df["F1@0.5"].mean()
            avg_time = times[tag].mean()

            lines.append(
                f"- {tag.upper():11s}  "
                f"AUROC(macro) = {macro_auroc:.3f}   "
                f"F1(macro) = {macro_f1:.3f}   "
                f"Avg inference time = {avg_time:.2f} ms"
            )

        ax.text(
            0.03,
            0.95,
            "MedCLIP Zero-Shot Disease Classification – Summary",
            fontsize=12,
            weight="bold",
            va="top",
        )
        ax.text(0.03, 0.80, "\n".join(lines), fontsize=10, va="top")

        caption = (
            "Notes:\n"
            "• Macro AUROC and Macro F1@0.5 are computed by averaging over the 5 CheXpert\n"
            "  competition diseases (Atelectasis, Cardiomegaly, Consolidation, Edema, Pleural Effusion).\n"
            "• Inference times are per-image CPU runtimes for the MedCLIP PromptClassifier\n"
            "  zero-shot head using the corresponding preprocessing pipeline.\n"
        )
        ax.text(0.03, 0.25, caption, fontsize=9, va="top")

        fig.tight_layout(rect=[0.02, 0.02, 0.98, 0.98])
        pdf.savefig(fig)
        plt.close(fig)

    print("Combined comparison PDF saved to:")
    print("   ", OUTPUT_PDF)


if __name__ == "__main__":
    main()
